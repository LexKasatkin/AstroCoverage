<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Astro Coverage Atlas</title>
<link rel="icon" type="image/png" href="favicon.png">

<style>
:root {
  --bg:#1e1e1e;
  --fg:#eaeaea;
  --border:#444;
  --hover:#333;
  --input-bg:#2a2a2a;
}

body {
  margin:0;
  display:flex;
  height:100vh;
  font-family:sans-serif;
  background:var(--bg);
  color:var(--fg);
}

/* Sidebar */
#sidebar {
  width:300px;
  border-right:1px solid var(--border);
  padding:10px;
  display:flex;
  flex-direction:column;
  overflow-y:auto;
}

/* Telescopes toggle */
#telToggle {
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:pointer;
  font-weight:bold;
  margin-bottom:5px;
}
#telToggle i {
  transition: transform 0.3s;
  display:inline-block;
}
#telToggle.open i {
  transform: rotate(180deg);
}

/* Telescopes section */
#telSection {
  overflow:hidden;
  max-height:0;
  opacity:0;
  transition:max-height 0.3s ease, opacity 0.3s ease;
  margin-bottom:10px;
}

/* Aladin */
#aladin-lite-div {
  flex:1;
  min-height:100vh;
}

/* Frames */
.frame {
  cursor:pointer;
  padding:4px;
}
.frame:hover {
  background:var(--hover);
}

/* Inputs */
input, select, button {
  width:100%;
  margin-bottom:5px;
  padding:4px;
  background:var(--input-bg);
  color:var(--fg);
  border:1px solid var(--border);
}
button {
  cursor:pointer;
}

#regenBtn {
  margin-top: 10px;
}

/* ===== PROGRESS BAR ===== */
#progressWrap {
  display:none;
  margin-top:10px;
}
#progressOuter {
  width:100%;
  height:14px;
  background:#333;
  border-radius:7px;
  overflow:hidden;
}
#progressInner {
  height:100%;
  width:0%;
  background:lime;
  transition:width 0.3s ease;
}
#progressText {
  font-size:12px;
  margin-top:4px;
  text-align:center;
  color:#ccc;
}

/* Loader */
#loader {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.3);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9998;
}
#loader div {
  padding:20px;
  background:var(--bg);
  border-radius:5px;
  font-weight:bold;
}

/* ===== TELESCOPES COMPACT FIX ===== */
#telescopes .frame {
  padding: 2px 4px;
  display:flex;
  align-items:center;
  gap:6px;
}

#telescopes .frame b {
  font-size:13px;
  line-height:1.2;
  font-weight:500;
}

.tel-btn {
  border:none;
  background:none;
  cursor:pointer;
  font-size:14px;
  padding:0 2px;
  height:18px;
  width:18px;
  line-height:18px;
  display:flex;
  align-items:center;
  justify-content:center;
  transition:transform 0.2s;
}
.tel-btn:hover {
  transform:scale(1.2);
}
.tel-btn.edit {
  transform:rotate(-45deg);
}

/* Frame file second line */
.frame .file {
  font-size:13px;
  color:#ccc;
}

/* Modal */
.modal {
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  background:rgba(0,0,0,.6);
  z-index:9999;
}
.modal-content {
  background:var(--bg);
  padding:20px;
  min-width:300px;
}
.modal input {
  width:100%;
  margin-bottom:6px;
}
</style>
</head>

<body>

<div id="sidebar">

  <button onclick="openSettings()">‚öô ASTAP</button>

  <div id="telToggle">
    <span>–¢–µ–ª–µ—Å–∫–æ–ø—ã</span>
    <i>‚ñæ</i>
  </div>

  <div id="telSection">
    <div id="telescopes"></div>
  </div>

  <button onclick="openTelescope()">+ –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–ª–µ—Å–∫–æ–ø</button>

  <h3>–í—ã–±–æ—Ä –¥–∞—Ç—ã</h3>
  <select id="dateSelect"></select>

  <h3>–§—Ä–µ–π–º—ã</h3>
  <div id="frames"></div>

  <!-- PROGRESS BAR -->
  <div id="progressWrap">
    <div id="progressOuter">
      <div id="progressInner"></div>
    </div>
    <div id="progressText">0%</div>
  </div>

  <button id="regenBtn">–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
</div>

<div id="aladin-lite-div"></div>

<div id="loader"><div>–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>

<!-- TELECOPE MODAL -->
<div class="modal" id="telModal">
  <div class="modal-content">
    <h3 id="telTitle"></h3>
    <input id="telName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
    <input id="telPath" placeholder="–ü—É—Ç—å –∫ FITS">
    <button onclick="saveTelescope()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button onclick="closeTel()">–û—Ç–º–µ–Ω–∞</button>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div class="modal" id="settingsModal">
  <div class="modal-content">
    <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ASTAP</h3>
    <input id="astapPath" placeholder="ASTAP path">
    <button onclick="saveAstap()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button onclick="closeSettings()">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<script src="https://aladin.cds.unistra.fr/AladinLite/api/v3/latest/aladin.js"></script>
<script>
/* ===== LOADER ===== */
const loader = document.getElementById("loader");
let loaderShown = false;
function showLoader(){ if(!loaderShown){ loader.style.display="flex"; loaderShown=true; } }
function hideLoader(){ loader.style.display="none"; loaderShown=false; }

/* ===== PROGRESS ===== */
const progressWrap = document.getElementById("progressWrap");
const progressInner = document.getElementById("progressInner");
const progressText = document.getElementById("progressText");
let progressTimer = null;

function startProgress() {
  if (progressTimer) return;
  progressWrap.style.display = "block";

  progressTimer = setInterval(async () => {
    try {
      const r = await fetch("/generation_status");
      const s = await r.json();

      if (!s.running) {
        stopProgress();
        loadData();
        return;
      }

      const percent = s.total ? Math.round((s.done / s.total) * 100) : 0;
      progressInner.style.width = percent + "%";
      progressText.textContent = percent + "%";

    } catch {}
  }, 800);
}

function stopProgress() {
  clearInterval(progressTimer);
  progressTimer = null;
  progressWrap.style.display = "none";
  progressInner.style.width = "0%";
  progressText.textContent = "0%";
}

/* ===== COLORS ===== */
const colors = ["lime","red","blue","orange","cyan","magenta"];
let scopeColors = {};

/* ===== DATA ===== */
let aladin, overlay, data={}, selectedDate=null, config={};

/* ===== ALADIN ===== */
function initAladin(){
  A.init.then(()=>{
    aladin=A.aladin('#aladin-lite-div',{survey:"https://alaskybis.cds.unistra.fr/DSS/DSSColor", fov:60});
    overlay=A.graphicOverlay({lineWidth:3});
    aladin.addOverlay(overlay);
    loadData();
  });
}

/* ===== DATA LOAD ===== */
function loadData(auto=false){
  const fn = auto ? fetch : fetchWithLoader;
  fn("/data.json")
    .then(r=>r.json())
    .then(json=>{
      data=json;
      updateDateSelect(selectedDate);
    })
    .catch(()=>data={});
}

async function fetchWithLoader(url, options){
  showLoader();
  try {
    const res = await fetch(url, options);
    return await res;
  } finally {
    hideLoader();
  }
}

/* ===== DATE ===== */
function updateDateSelect(preservedDate=null){
  const sel=document.getElementById("dateSelect");
  sel.innerHTML="";
  let dates=new Set();
  Object.values(data).forEach(s=>Object.keys(s).forEach(d=>dates.add(d)));
  [...dates].sort().forEach(d=>{
    const o=document.createElement("option");
    o.value=d; o.textContent=d;
    sel.appendChild(o);
  });

  if(preservedDate && [...sel.options].some(o=>o.value===preservedDate)){
    sel.value=preservedDate;
  } else if(sel.options.length){
    sel.value=sel.options[0].value;
  }

  selectedDate=sel.value;
  showFrames(selectedDate);
  sel.onchange=()=>{ selectedDate=sel.value; showFrames(sel.value); };
}

/* ===== FRAMES ===== */
function showFrames(date){
  const framesDiv=document.getElementById("frames");
  framesDiv.innerHTML="";
  overlay.removeAll();

  Object.entries(data).forEach(([scope, scopeData])=>{
    const frames=scopeData[date];
    if(!frames) return;

    if (!scopeColors[scope]) {
      const idx = Object.keys(scopeColors).length;
      scopeColors[scope] = colors[idx % colors.length];
    }
    const color = scopeColors[scope];

    frames.forEach(frame=>{
      overlay.add(A.polygon(frame.polygon,{color, lineWidth:3, fill:false}));

      const d=document.createElement("div");
      d.className="frame";
      const file=frame.file?.replace(/\.(fits|fit|fts)$/i,"")||"frame";
      d.innerHTML=`<div>${scope}</div><div class="file">${file}</div>`;

      d.onclick=()=>{
        const lons=frame.polygon.map(p=>p[0]);
        const lats=frame.polygon.map(p=>p[1]);
        aladin.gotoRaDec(
          (Math.min(...lons)+Math.max(...lons))/2,
          (Math.min(...lats)+Math.max(...lats))/2,
          3
        );
      };
      framesDiv.appendChild(d);
    });
  });
}

/* ===== CONFIG ===== */
function rebuildScopeColors(){
  scopeColors = {};
  config.telescopes.forEach((t,i)=>{
    scopeColors[t.name] = colors[i % colors.length];
  });
}
function loadConfig(){
  fetchWithLoader("/config")
    .then(r=>r.json())
    .then(c=>{
      config=c;
      rebuildScopeColors();
      renderTelescopes();
      astapPath.value=c.astap_path||"";
      if (selectedDate) showFrames(selectedDate);
    });
}

function renderTelescopes(){
  const c=document.getElementById("telescopes");
  c.innerHTML="";
  config.telescopes.forEach(t=>{
    const d=document.createElement("div");
    d.className="frame";
    d.innerHTML=`
      <b>${t.name}</b>
      <div style="margin-left:auto; display:flex; gap:4px;">
        <button class="tel-btn edit" onclick="editTel('${t.id}')">‚úè</button>
        <button class="tel-btn" onclick="delTel('${t.id}')">üóë</button>
      </div>`;
    c.appendChild(d);
  });
}

/* ===== TELESCOPES CRUD ===== */
let editId=null;
function openTelescope(){
  editId=null;
  telTitle.textContent="–î–æ–±–∞–≤–∏—Ç—å —Ç–µ–ª–µ—Å–∫–æ–ø";
  telName.value="";
  telPath.value="";
  telModal.style.display="flex";
}
function editTel(id){
  const t=config.telescopes.find(t=>t.id===id);
  editId=id;
  telTitle.textContent="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–ª–µ—Å–∫–æ–ø";
  telName.value=t.name;
  telPath.value=t.fits_dir;
  telModal.style.display="flex";
}
function saveTelescope(){
  const payload={name:telName.value,path:telPath.value};
  const url=editId?`/config/telescope/${editId}`:"/config/telescope";
  closeTel();
  startProgress();
  fetch(url,{
    method:editId?"PUT":"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(payload)
  }).then(()=>{
    loadConfig();
    loadData();
  }).finally(hideLoader);
}
function delTel(id){
  if(!confirm("–£–¥–∞–ª–∏—Ç—å —Ç–µ–ª–µ—Å–∫–æ–ø?")) return;
  showLoader();
  fetch(`/config/telescope/${id}`,{method:"DELETE"})
    .then(()=>{ loadConfig(); loadData(); })
    .finally(hideLoader);
}
function closeTel(){ telModal.style.display="none"; }

/* ===== SETTINGS ===== */
function openSettings(){ settingsModal.style.display="flex"; }
function closeSettings(){ settingsModal.style.display="none"; }
function saveAstap(){
  showLoader();
  fetch("/config/astap",{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({path:astapPath.value})
  }).then(()=>{ closeSettings(); loadConfig(); loadData(); })
    .finally(hideLoader);
}

/* ===== TOGGLE ===== */
telToggle.onclick=()=>{
  if(telSection.style.maxHeight && telSection.style.maxHeight!=="0px"){
    telSection.style.maxHeight="0";
    telSection.style.opacity=0;
    telToggle.classList.remove("open");
  } else {
    telSection.style.maxHeight=telSection.scrollHeight+"px";
    telSection.style.opacity=1;
    telToggle.classList.add("open");
  }
};

/* ===== REGEN ===== */
regenBtn.onclick=()=>{
  fetch("/regen_data",{method:"POST"});
  startProgress();
};

loadConfig();
initAladin();
setInterval(()=>loadData(true),10000);
</script>

</body>
</html>
