<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Astro Coverage Atlas</title>

<style>
:root { --bg:#1e1e1e; --fg:#eaeaea; --border:#444; --hover:#333; --input-bg:#2a2a2a; }
body { margin:0; display:flex; height:100vh; font-family:sans-serif; background:var(--bg); color:var(--fg);}

/* Sidebar */
#sidebar { width:300px; border-right:1px solid var(--border); padding:10px; display:flex; flex-direction:column; overflow-y:auto; transition:width 0.2s;}

/* Telescopes section */
#telToggle { display:flex; justify-content:space-between; align-items:center; cursor:pointer; font-weight:bold; margin-bottom:5px; }
#telToggle span { user-select:none; }
#telSection { overflow:hidden; max-height:0; transition:max-height 0.3s ease, opacity 0.3s ease; margin-bottom:10px; opacity:0; }

/* Aladin */
#aladin-lite-div { flex:1; min-height:100vh;}

/* Frames */
.frame { cursor:pointer; padding:4px; display:flex; justify-content:space-between; align-items:center; }
.frame:hover { background:var(--hover); }

/* Inputs and buttons */
input, select, button { width:100%; margin-bottom:5px; padding:4px; background:var(--input-bg); color:var(--fg); border:1px solid var(--border); }
button { padding:4px; cursor:pointer; }

/* Special regen button */
#regenBtn { margin-top:20px; }

/* Modal */
.modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.6); z-index:9999; }
.modal-content { background:var(--bg); padding:20px; min-width:300px; }
.modal input { width:100%; margin-bottom:6px; }

/* Loader */
#loader { position:fixed; inset:0; background:rgba(0,0,0,0.3); display:none; align-items:center; justify-content:center; z-index:9998; }
#loader div { padding:20px; background:var(--bg); color:var(--fg); border-radius:5px; font-weight:bold; }

/* Telescopes buttons */
.tel-btn { border:none; background:none; cursor:pointer; padding:2px 4px; margin-left:2px; font-size:16px; display:flex; align-items:center; justify-content:center; transition: transform 0.2s; }
.tel-btn:hover { transform: scale(1.2); }
.tel-btn.edit { transform: rotate(-45deg); } /* –∫–∞—Ä–∞–Ω–¥–∞—à –ø–æ–¥ —É–≥–ª–æ–º */

/* –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–ª–µ—Å–∫–æ–ø–∞ –º–µ–Ω—å—à–µ */
#telescopes .frame b { font-size: 14px; }

/* Toggle icon */
#telToggle i { transition: transform 0.3s; display:inline-block; }
#telToggle.open i { transform: rotate(180deg); }
</style>
</head>

<body>

<div id="sidebar">

  <!-- ASTAP settings -->
  <button onclick="openSettings()">‚öô ASTAP</button>

  <!-- Telescopes toggle -->
  <div id="telToggle">
    <span>–¢–µ–ª–µ—Å–∫–æ–ø—ã</span>
    <i>‚ñæ</i>
  </div>

  <!-- Telescopes section -->
  <div id="telSection">
    <div id="telescopes"></div>
  </div>

  <!-- Add telescope button -->
  <button onclick="openTelescope()">+ –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–ª–µ—Å–∫–æ–ø</button>

  <h3>–í—ã–±–æ—Ä –¥–∞—Ç—ã</h3>
  <select id="dateSelect"></select>

  <h3>–§—Ä–µ–π–º—ã</h3>
  <div id="frames"></div>

  <button id="regenBtn">–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
</div>

<div id="aladin-lite-div"></div>

<!-- LOADER -->
<div id="loader"><div>–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>

<!-- TELECOPE MODAL -->
<div class="modal" id="telModal">
  <div class="modal-content">
    <h3 id="telTitle"></h3>
    <input id="telName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
    <input id="telPath" placeholder="–ü—É—Ç—å –∫ FITS">
    <button onclick="saveTelescope()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button onclick="closeTel()">–û—Ç–º–µ–Ω–∞</button>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div class="modal" id="settingsModal">
  <div class="modal-content">
    <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ASTAP</h3>
    <input id="astapPath" placeholder="ASTAP path">
    <button onclick="saveAstap()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button onclick="closeSettings()">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<script src="https://aladin.cds.unistra.fr/AladinLite/api/v3/latest/aladin.js"></script>
<script>
/* LOADER */
const loader = document.getElementById("loader");
let loaderShown = false;
function showLoader(){ if(!loaderShown){ loader.style.display="flex"; loaderShown=true; } }
function hideLoader(){ loader.style.display="none"; loaderShown=false; }

/* ALADIN + DATA */
let aladin, overlay, data={}, selectedDate=null;
const colors=["lime","red","blue","orange","cyan","magenta"];
function getColorForScope(scopeId){ const index=Math.abs([...scopeId].reduce((sum,c)=>sum+c.charCodeAt(0),0))%colors.length; return colors[index]; }

/* –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö: auto=true - –±–µ–∑ –ª–æ–∞–¥–µ—Ä–∞ */
function loadData(auto=false){
  if(auto){
    fetch("/data.json").then(res=>res.json()).then(json=>{
      data=json;
      updateDateSelect(selectedDate);
    }).catch(()=>data={});
  } else {
    fetchWithLoader("/data.json").then(json=>{
      data=json;
      updateDateSelect(selectedDate);
    }).catch(()=>data={});
  }
}

/* FETCH WRAPPER */
async function fetchWithLoader(url, options){
  showLoader();
  try { const res = await fetch(url, options); return await res.json(); }
  finally{ hideLoader(); }
}

function initAladin(){
  A.init.then(()=>{
    aladin=A.aladin('#aladin-lite-div',{survey:"https://alaskybis.cds.unistra.fr/DSS/DSSColor", fov:60});
    overlay=A.graphicOverlay({lineWidth:3});
    aladin.addOverlay(overlay);
    loadData();
  });
}

/* DATE SELECT */
function updateDateSelect(preservedDate=null){
  const sel=document.getElementById("dateSelect");
  sel.innerHTML="";
  let dates=new Set();
  Object.values(data).forEach(scopeData=>Object.keys(scopeData).forEach(d=>dates.add(d)));
  [...dates].sort().forEach(d=>{
    const opt=document.createElement("option"); opt.value=d; opt.textContent=d; sel.appendChild(opt);
  });

  if(preservedDate && [...sel.options].some(o=>o.value===preservedDate)){
    sel.value = preservedDate;
    selectedDate = preservedDate;
  } else if(sel.options.length){
    sel.value = sel.options[0].value;
    selectedDate = sel.options[0].value;
  }

  showFrames(sel.value);
  sel.onchange=()=>{ selectedDate = sel.value; showFrames(sel.value); };
}

/* SHOW FRAMES */
function showFrames(selectedDate){
  const framesDiv=document.getElementById("frames"); framesDiv.innerHTML="";
  overlay.removeAll();
  Object.entries(data).forEach(([scope, scopeData])=>{
    const frames = selectedDate? scopeData[selectedDate]: null; if(!frames) return;
    const color = getColorForScope(scope);
    frames.forEach(frame=>{
      overlay.add(A.polygon(frame.polygon,{color,lineWidth:3,fill:false}));
      const div=document.createElement("div"); div.className="frame";
      const file = frame.file? frame.file.replace(/\.(fits|fit|fts)$/i,""):"frame";
      div.innerHTML=`<span>${scope} ‚Äì ${frame.datetime||""} ‚Äì ${file}</span>`;
      div.onclick=()=>{
        const lons=frame.polygon.map(p=>p[0]), lats=frame.polygon.map(p=>p[1]);
        const centerRA=(Math.min(...lons)+Math.max(...lons))/2;
        const centerDec=(Math.min(...lats)+Math.max(...lats))/2;
        aladin.gotoRaDec(centerRA, centerDec, 3);
      };
      framesDiv.appendChild(div);
    });
  });
}

/* TELESCOPES + SETTINGS */
let config={}, editId=null;
function loadConfig(){
  fetchWithLoader("/config").then(c=>{
    config=c;
    renderTelescopes();
    astapPath.value=c.astap_path||"";
  });
}

function renderTelescopes(){
  const container=document.getElementById("telescopes");
  container.innerHTML="";
  config.telescopes.forEach(t=>{
    const d=document.createElement("div");
    d.className="frame";
    d.innerHTML=`
      <b>${t.name}</b>
      <div style="margin-left:auto; display:flex; gap:4px;">
        <button class="tel-btn edit" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" onclick="editTel('${t.id}')">‚úè</button>
        <button class="tel-btn" title="–£–¥–∞–ª–∏—Ç—å" onclick="delTel('${t.id}')">üóë</button>
      </div>`;
    container.appendChild(d);
  });

  if(container.parentElement.style.maxHeight && container.parentElement.style.maxHeight !== "0px"){
    container.parentElement.style.maxHeight = container.scrollHeight + "px";
  }
}

function openTelescope(){ 
  editId=null; 
  telTitle.textContent="–î–æ–±–∞–≤–∏—Ç—å —Ç–µ–ª–µ—Å–∫–æ–ø"; 
  telName.value=""; 
  telPath.value=""; 
  telModal.style.display="flex"; 
}

function editTel(id){ 
  const t=config.telescopes.find(t=>t.id===id); 
  editId=id; 
  telTitle.textContent="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–ª–µ—Å–∫–æ–ø"; 
  telName.value=t.name; 
  telPath.value=t.fits_dir; 
  telModal.style.display="flex"; 
}

function saveTelescope(){ 
  const payload={name:telName.value,path:telPath.value}; 
  const url=editId?`/config/telescope/${editId}`:"/config/telescope"; 
  showLoader();
  fetch(url,{
    method: editId?"PUT":"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(payload)
  })
  .then(()=>{ closeTel(); loadConfig(); loadData(); })
  .finally(hideLoader);
}

function delTel(id){ 
  if(!confirm("–£–¥–∞–ª–∏—Ç—å —Ç–µ–ª–µ—Å–∫–æ–ø?")) return; 
  showLoader();
  fetch(`/config/telescope/${id}`,{method:"DELETE"})
    .then(()=>{ loadConfig(); loadData(); })
    .finally(hideLoader);
}

function closeTel(){ telModal.style.display="none"; }

function openSettings(){ settingsModal.style.display="flex"; }
function closeSettings(){ settingsModal.style.display="none"; }

function saveAstap(){ 
  const payload={path:astapPath.value};
  showLoader();
  fetch("/config/astap",{method:"POST", headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)})
    .then(()=>{ closeSettings(); loadConfig(); loadData(); })
    .finally(hideLoader);
}

/* TELESCOPES TOGGLE BUTTON */
const telToggle = document.getElementById("telToggle");
const telSection = document.getElementById("telSection");
telToggle.onclick = ()=>{
  if(telSection.style.maxHeight && telSection.style.maxHeight !== "0px"){
    telSection.style.maxHeight = "0";
    telSection.style.opacity = 0;
    telToggle.classList.remove("open");
  } else {
    telSection.style.maxHeight = telSection.scrollHeight + "px";
    telSection.style.opacity = 1;
    telToggle.classList.add("open");
  }
};

/* REGEN DATA */
document.getElementById("regenBtn").onclick=()=>{
  showLoader();
  fetch("/regen_data",{method:"POST"})
    .then(()=>{ loadData(); alert("data.json –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω"); })
    .finally(hideLoader);
}

loadConfig();
initAladin();

/* AUTO REFRESH –±–µ–∑ –ª–æ–∞–¥–µ—Ä–∞ */
setInterval(()=>loadData(true),10000);
</script>

</body>
</html>
